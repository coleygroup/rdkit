name: wheels-rdkit-typer

on:
  workflow_dispatch:
    inputs:
      repair_only:
        description: "Run Linux repair replay only (skip wheel build/publish)"
        required: false
        default: "false"
      repair_run_id:
        description: "Workflow run ID containing linux-repair-state artifact"
        required: false
        default: ""
  push:
    tags:
      - "rdkit-typer-v*"

permissions:
  contents: read
  actions: read

jobs:
  build_wheels:
    if: github.event_name != 'workflow_dispatch' || github.event.inputs.repair_only != 'true'
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up micromamba (macOS host deps)
        id: micromamba
        if: runner.os != 'Linux'
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: rdkit-wheel-deps
          condarc: |
            channels:
              - conda-forge
          create-args: >-
            cmake
            ninja
            boost
            boost-cpp
            libboost-devel
            libboost-python
            libboost-python-devel
            eigen
            cairo
            freetype
            libpng
            zlib
            expat

      - name: Print dependency prefix (macOS)
        if: runner.os != 'Linux'
        run: |
          echo "micromamba env path: ${{ steps.micromamba.outputs.environment-path }}"

      - name: Validate Linux repair script syntax
        if: runner.os == 'Linux'
        run: |
          bash -n .github/scripts/repair_linux_wheel.sh

      - name: Build wheels
        if: runner.os == 'Linux'
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_CONFIG_FILE: cibuildwheel.toml
          CIBW_BUILD: cp312-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS_LINUX: x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: quay.io/pypa/manylinux_2_34_x86_64:latest
          CIBW_BEFORE_BUILD: >-
            python -m pip install --upgrade pip setuptools wheel numpy
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >-
            bash /project/.github/scripts/repair_linux_wheel.sh {wheel} {dest_dir}
          # Linux uses manylinux containers. Bootstrap native deps inside container.
          CIBW_BEFORE_ALL_LINUX: >-
            set -euxo pipefail;
            curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba;
            ./bin/micromamba create -y -p /opt/rdkit-deps -c conda-forge
            cmake ninja boost-cpp libboost-devel libboost-python libboost-python-devel eigen cairo freetype libpng zlib expat;
            /opt/rdkit-deps/bin/cmake --version;
            ls -la /opt/rdkit-deps/lib || true
          CIBW_ENVIRONMENT_LINUX: >-
            CMAKE_PREFIX_PATH=/opt/rdkit-deps
            Boost_DIR=/opt/rdkit-deps/lib/cmake/Boost-1.85.0
            PKG_CONFIG_PATH=/opt/rdkit-deps/lib/pkgconfig
            LD_LIBRARY_PATH=/opt/rdkit-deps/lib:$LD_LIBRARY_PATH

      - name: Build wheels
        if: runner.os == 'macOS'
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_CONFIG_FILE: cibuildwheel.toml
          CIBW_BUILD: cp312-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS_MACOS: arm64
          CIBW_BEFORE_BUILD: >-
            python -m pip install --upgrade pip setuptools wheel numpy
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >-
            delocate-wheel --require-archs {delocate_archs} --ignore-missing-dependencies -w {dest_dir} -v {wheel}
          # macOS uses the host-installed micromamba environment.
          CIBW_ENVIRONMENT_MACOS: >-
            CMAKE_PREFIX_PATH=${{ steps.micromamba.outputs.environment-path }}
            Boost_DIR=${{ steps.micromamba.outputs.environment-path }}/lib/cmake/Boost-1.85.0
            PKG_CONFIG_PATH=${{ steps.micromamba.outputs.environment-path }}/lib/pkgconfig
            DYLD_FALLBACK_LIBRARY_PATH=${{ steps.micromamba.outputs.environment-path }}/lib

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

      - name: Upload Linux repair debug state
        if: failure() && runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: linux-repair-state
          retention-days: 3
          path: |
            /tmp/cibuildwheel
            /opt/rdkit-deps

  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build_wheels]
    if: (github.event_name != 'workflow_dispatch' || github.event.inputs.repair_only != 'true') && startsWith(github.ref, 'refs/tags/rdkit-typer-v')
    permissions:
      id-token: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

  publish_testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    needs: [build_wheels]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.repair_only != 'true'
    permissions:
      id-token: write
    environment:
      name: testpypi-rdcanon+

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://test.pypi.org/legacy/

  repair_linux_only:
    name: Repair Linux wheel only
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.repair_only == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate repair_run_id input
        run: |
          test -n "${{ github.event.inputs.repair_run_id }}"
          case "${{ github.event.inputs.repair_run_id }}" in
            ''|*[!0-9]*) echo "repair_run_id must be a numeric workflow run id"; exit 1 ;;
          esac

      - name: Download linux repair state from prior run
        uses: dawidd6/action-download-artifact@v6
        with:
          repo: ${{ github.repository }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.inputs.repair_run_id }}
          name: linux-repair-state
          path: .

      - name: Show downloaded debug files
        run: |
          find . -maxdepth 4 -type d | sort

      - name: Install auditwheel
        run: |
          python -m pip install --upgrade pip auditwheel

      - name: Replay Linux repair step
        run: |
          WHEEL_PATH=$(find . -type f -name '*.whl' | head -n1)
          test -n "$WHEEL_PATH"
          mkdir -p repaired_wheel
          export SEARCH_ROOTS="$(pwd)"
          bash .github/scripts/repair_linux_wheel.sh "$WHEEL_PATH" "$(pwd)/repaired_wheel"

      - name: Upload repaired wheel replay artifact
        uses: actions/upload-artifact@v4
        with:
          name: repaired-wheel-replay
          path: repaired_wheel/*.whl
