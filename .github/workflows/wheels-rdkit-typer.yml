name: wheels-rdkit-typer

on:
  workflow_dispatch:
  push:
    tags:
      - "rdkit-typer-v*"

permissions:
  contents: read

jobs:
  build_wheels:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up micromamba (macOS host deps)
        id: micromamba
        if: runner.os != 'Linux'
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-name: rdkit-wheel-deps
          condarc: |
            channels:
              - conda-forge
          create-args: >-
            cmake
            ninja
            boost
            boost-cpp
            libboost-devel
            libboost-python
            libboost-python-devel
            eigen
            cairo
            freetype
            libpng
            zlib
            expat

      - name: Print dependency prefix (macOS)
        if: runner.os != 'Linux'
        run: |
          echo "micromamba env path: ${{ steps.micromamba.outputs.environment-path }}"

      - name: Build wheels
        if: runner.os == 'Linux'
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_CONFIG_FILE: cibuildwheel.toml
          CIBW_BUILD: cp312-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS_LINUX: x86_64
          CIBW_MANYLINUX_X86_64_IMAGE: quay.io/pypa/manylinux_2_34_x86_64:latest
          CIBW_BEFORE_BUILD: >-
            python -m pip install --upgrade pip setuptools wheel numpy
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >-
            find /tmp -type f -name 'libRDKit*.so.*' | while read -r f; do
              d=$(dirname "$f");
              b=$(basename "$f");
              soname=$(printf '%s' "$b" | sed -E 's/^(libRDKit[^ ]*\.so\.[0-9]+).*/\1/');
              if [ -n "$soname" ] && [ ! -e "$d/$soname" ]; then ln -s "$b" "$d/$soname" || true; fi;
            done;
            RDKIT_LIB_DIRS=$(find /tmp -type f -name 'libRDKit*.so*' -printf '%h\n' | sort -u | tr '\n' ':');
            export LD_LIBRARY_PATH="${RDKIT_LIB_DIRS}/opt/rdkit-deps/lib:${LD_LIBRARY_PATH}";
            auditwheel repair -w {dest_dir} {wheel}
          # Linux uses manylinux containers. Bootstrap native deps inside container.
          CIBW_BEFORE_ALL_LINUX: >-
            set -euxo pipefail;
            curl -Ls https://micro.mamba.pm/api/micromamba/linux-64/latest | tar -xvj bin/micromamba;
            ./bin/micromamba create -y -p /opt/rdkit-deps -c conda-forge
            cmake ninja boost-cpp libboost-devel libboost-python libboost-python-devel eigen cairo freetype libpng zlib expat;
            /opt/rdkit-deps/bin/cmake --version;
            ls -la /opt/rdkit-deps/lib || true
          CIBW_ENVIRONMENT_LINUX: >-
            CMAKE_PREFIX_PATH=/opt/rdkit-deps
            Boost_DIR=/opt/rdkit-deps/lib/cmake/Boost-1.85.0
            PKG_CONFIG_PATH=/opt/rdkit-deps/lib/pkgconfig
            LD_LIBRARY_PATH=/opt/rdkit-deps/lib:$LD_LIBRARY_PATH

      - name: Build wheels
        if: runner.os == 'macOS'
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_CONFIG_FILE: cibuildwheel.toml
          CIBW_BUILD: cp312-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS_MACOS: arm64
          CIBW_BEFORE_BUILD: >-
            python -m pip install --upgrade pip setuptools wheel numpy
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >-
            delocate-wheel --require-archs {delocate_archs} --ignore-missing-dependencies -w {dest_dir} -v {wheel}
          # macOS uses the host-installed micromamba environment.
          CIBW_ENVIRONMENT_MACOS: >-
            CMAKE_PREFIX_PATH=${{ steps.micromamba.outputs.environment-path }}
            Boost_DIR=${{ steps.micromamba.outputs.environment-path }}/lib/cmake/Boost-1.85.0
            PKG_CONFIG_PATH=${{ steps.micromamba.outputs.environment-path }}/lib/pkgconfig
            DYLD_FALLBACK_LIBRARY_PATH=${{ steps.micromamba.outputs.environment-path }}/lib

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  publish_pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build_wheels]
    if: startsWith(github.ref, 'refs/tags/rdkit-typer-v')
    permissions:
      id-token: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

  publish_testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    needs: [build_wheels]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
    environment:
      name: testpypi-rdcanon+

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          repository-url: https://test.pypi.org/legacy/
